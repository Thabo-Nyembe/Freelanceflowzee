'use client'

import { useState } from 'react'
import {
  Search,
  Shield,
  AlertTriangle,
  CheckCircle2,
  XCircle,
  Clock,
  Activity,
  TrendingUp,
  Settings,
  Bug,
  Code,
  Package,
  Server,
  Database,
  Cloud,
  BarChart3,
  Calendar,
  Filter,
  Zap,
  FileText,
  AlertCircle,
  Info,
  Bell,
  Play,
  RefreshCw,
  Plus
} from 'lucide-react'
import StatGrid from '@/components/dashboard-results/StatGrid'
import BentoQuickAction from '@/components/dashboard-results/BentoQuickAction'
import PillButton from '@/components/modern-button-suite/PillButton'
import MiniKPI from '@/components/dashboard-results/MiniKPI'
import ActivityFeed from '@/components/dashboard-results/ActivityFeed'
import RankingList from '@/components/dashboard-results/RankingList'
import ProgressCard from '@/components/dashboard-results/ProgressCard'
import { useVulnerabilityScans, VulnerabilityScan } from '@/lib/hooks/use-vulnerability-scans'

type ScanStatus = 'completed' | 'in-progress' | 'failed' | 'scheduled' | 'cancelled'
type ScanType = 'dependency' | 'code' | 'container' | 'infrastructure' | 'web-application' | 'network' | 'api'

interface VulnerabilityScanClientProps {
  initialScans: VulnerabilityScan[]
  initialStats: {
    total: number
    scheduled: number
    inProgress: number
    completed: number
    failed: number
    totalVulnerabilities: number
    criticalCount: number
    highCount: number
    fixedCount: number
    fixRate: number
  }
}

export default function VulnerabilityScanClient({ initialScans, initialStats }: VulnerabilityScanClientProps) {
  const [viewMode, setViewMode] = useState<'all' | ScanStatus>('all')
  const [typeFilter, setTypeFilter] = useState<'all' | ScanType>('all')
  const [showCreateModal, setShowCreateModal] = useState(false)

  const {
    scans: realtimeScans,
    loading,
    createScan,
    updateScan,
    deleteScan,
    startScan,
    completeScan,
    cancelScan,
    rescan,
    getStats
  } = useVulnerabilityScans()

  // Use realtime data if available, otherwise use initial data
  const scans = realtimeScans.length > 0 ? realtimeScans : initialScans
  const stats = realtimeScans.length > 0 ? getStats() : initialStats

  const filteredScans = scans.filter(scan => {
    if (viewMode !== 'all' && scan.status !== viewMode) return false
    if (typeFilter !== 'all' && scan.scan_type !== typeFilter) return false
    return true
  })

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'text-green-600 bg-green-50'
      case 'in-progress': return 'text-blue-600 bg-blue-50'
      case 'failed': return 'text-red-600 bg-red-50'
      case 'scheduled': return 'text-purple-600 bg-purple-50'
      case 'cancelled': return 'text-gray-600 bg-gray-50'
      default: return 'text-gray-600 bg-gray-50'
    }
  }

  const getTypeColor = (type: string) => {
    switch (type) {
      case 'dependency': return 'text-blue-600 bg-blue-50'
      case 'code': return 'text-purple-600 bg-purple-50'
      case 'container': return 'text-cyan-600 bg-cyan-50'
      case 'infrastructure': return 'text-orange-600 bg-orange-50'
      case 'web-application': return 'text-green-600 bg-green-50'
      case 'network': return 'text-indigo-600 bg-indigo-50'
      case 'api': return 'text-pink-600 bg-pink-50'
      default: return 'text-gray-600 bg-gray-50'
    }
  }

  const formatDuration = (seconds: number) => {
    if (seconds === 0) return 'N/A'
    const minutes = Math.floor(seconds / 60)
    const secs = seconds % 60
    return minutes > 0 ? `${minutes}m ${secs}s` : `${secs}s`
  }

  const handleCreateScan = async () => {
    try {
      await createScan({
        name: 'New Security Scan',
        description: 'Security scan description',
        scan_type: 'dependency',
        scanner: 'Snyk',
        target: 'package.json'
      })
      setShowCreateModal(false)
    } catch (error) {
      console.error('Failed to create scan:', error)
    }
  }

  const handleStartScan = async (id: string) => {
    try {
      await startScan(id)
    } catch (error) {
      console.error('Failed to start scan:', error)
    }
  }

  const handleCompleteScan = async (id: string, success: boolean) => {
    try {
      await completeScan(id, success)
    } catch (error) {
      console.error('Failed to complete scan:', error)
    }
  }

  const handleRescan = async (id: string) => {
    try {
      await rescan(id)
    } catch (error) {
      console.error('Failed to rescan:', error)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 p-8">
      <div className="max-w-7xl mx-auto space-y-8">

        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-red-900 via-orange-800 to-yellow-900 bg-clip-text text-transparent mb-2">
              Vulnerability Scans
            </h1>
            <p className="text-slate-600">Security vulnerability detection and remediation tracking</p>
          </div>
          <button
            onClick={() => setShowCreateModal(true)}
            className="px-6 py-3 bg-gradient-to-r from-red-500 to-orange-600 text-white rounded-xl hover:shadow-lg transition-all flex items-center gap-2"
          >
            <Plus className="w-5 h-5" />
            New Scan
          </button>
        </div>

        {/* Stats Grid */}
        <StatGrid
          stats={[
            {
              label: 'Total Scans',
              value: stats.total.toString(),
              icon: Search,
              trend: { value: 12, isPositive: true },
              color: 'red'
            },
            {
              label: 'Completed',
              value: stats.completed.toString(),
              icon: CheckCircle2,
              trend: { value: 8, isPositive: true },
              color: 'green'
            },
            {
              label: 'Vulnerabilities',
              value: stats.totalVulnerabilities.toString(),
              icon: AlertTriangle,
              trend: { value: 15, isPositive: false },
              color: 'orange'
            },
            {
              label: 'Fixed',
              value: stats.fixedCount.toString(),
              icon: Shield,
              trend: { value: 25, isPositive: true },
              color: 'blue'
            }
          ]}
        />

        {/* Quick Actions */}
        <BentoQuickAction
          actions={[
            {
              title: 'New Scan',
              description: 'Run scan now',
              icon: Search,
              gradient: 'from-red-500 to-orange-600',
              onClick: () => setShowCreateModal(true)
            },
            {
              title: 'Schedule Scan',
              description: 'Automate scans',
              icon: Calendar,
              gradient: 'from-blue-500 to-indigo-600',
              onClick: () => console.log('Schedule')
            },
            {
              title: 'View Vulnerabilities',
              description: 'All findings',
              icon: Bug,
              gradient: 'from-orange-500 to-red-600',
              onClick: () => console.log('Vulnerabilities')
            },
            {
              title: 'Remediation Queue',
              description: 'Fix issues',
              icon: CheckCircle2,
              gradient: 'from-green-500 to-emerald-600',
              onClick: () => console.log('Remediation')
            },
            {
              title: 'Reports',
              description: 'Export findings',
              icon: FileText,
              gradient: 'from-purple-500 to-pink-600',
              onClick: () => console.log('Reports')
            },
            {
              title: 'Integrations',
              description: 'Connect scanners',
              icon: Zap,
              gradient: 'from-cyan-500 to-blue-600',
              onClick: () => console.log('Integrations')
            },
            {
              title: 'Settings',
              description: 'Configure scans',
              icon: Settings,
              gradient: 'from-slate-500 to-gray-600',
              onClick: () => console.log('Settings')
            },
            {
              title: 'Alert Rules',
              description: 'Set notifications',
              icon: Bell,
              gradient: 'from-indigo-500 to-purple-600',
              onClick: () => console.log('Alerts')
            }
          ]}
        />

        {/* Filters */}
        <div className="flex flex-wrap gap-3">
          <div className="flex gap-2">
            <PillButton
              label="All Scans"
              isActive={viewMode === 'all'}
              onClick={() => setViewMode('all')}
            />
            <PillButton
              label="Completed"
              isActive={viewMode === 'completed'}
              onClick={() => setViewMode('completed')}
            />
            <PillButton
              label="In Progress"
              isActive={viewMode === 'in-progress'}
              onClick={() => setViewMode('in-progress')}
            />
            <PillButton
              label="Failed"
              isActive={viewMode === 'failed'}
              onClick={() => setViewMode('failed')}
            />
          </div>

          <div className="flex gap-2">
            <PillButton
              label="All Types"
              isActive={typeFilter === 'all'}
              onClick={() => setTypeFilter('all')}
            />
            <PillButton
              label="Dependencies"
              isActive={typeFilter === 'dependency'}
              onClick={() => setTypeFilter('dependency')}
            />
            <PillButton
              label="Code"
              isActive={typeFilter === 'code'}
              onClick={() => setTypeFilter('code')}
            />
            <PillButton
              label="Container"
              isActive={typeFilter === 'container'}
              onClick={() => setTypeFilter('container')}
            />
          </div>
        </div>

        {/* Main Content Grid */}
        <div className="grid lg:grid-cols-3 gap-8">

          {/* Scans List */}
          <div className="lg:col-span-2 space-y-4">
            {loading && scans.length === 0 ? (
              <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 text-center">
                <RefreshCw className="w-8 h-8 text-slate-400 mx-auto mb-4 animate-spin" />
                <p className="text-slate-600">Loading scans...</p>
              </div>
            ) : filteredScans.length === 0 ? (
              <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 text-center">
                <Search className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                <h3 className="text-lg font-semibold text-slate-900 mb-2">No scans found</h3>
                <p className="text-slate-600 mb-4">Get started by running your first vulnerability scan</p>
                <button
                  onClick={() => setShowCreateModal(true)}
                  className="px-4 py-2 bg-gradient-to-r from-red-500 to-orange-600 text-white rounded-lg text-sm font-medium"
                >
                  Run Scan
                </button>
              </div>
            ) : (
              filteredScans.map((scan) => (
                <div
                  key={scan.id}
                  className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-all"
                >
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <Search className="w-5 h-5 text-red-600" />
                        <h3 className="font-semibold text-slate-900">{scan.name}</h3>
                      </div>
                      <p className="text-sm text-slate-600 mb-1">{scan.description}</p>
                      <p className="text-xs text-slate-500">Scan ID: {scan.scan_code}</p>
                    </div>
                    <div className="flex gap-2">
                      <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(scan.status)}`}>
                        {scan.status}
                      </span>
                      <span className={`px-3 py-1 rounded-full text-xs font-medium ${getTypeColor(scan.scan_type)}`}>
                        {scan.scan_type}
                      </span>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="text-xs text-slate-500 mb-1">Scanner</p>
                      <p className="text-sm font-medium text-slate-900">{scan.scanner || 'N/A'}</p>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Target</p>
                      <p className="text-sm font-medium text-slate-900">{scan.target || 'N/A'}</p>
                    </div>
                  </div>

                  <div className="grid grid-cols-5 gap-4 mb-4">
                    <div>
                      <p className="text-xs text-slate-500 mb-1">Critical</p>
                      <div className="flex items-center gap-1">
                        <XCircle className="w-3 h-3 text-red-600" />
                        <span className="text-sm font-medium text-red-700">{scan.vuln_critical}</span>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">High</p>
                      <div className="flex items-center gap-1">
                        <AlertTriangle className="w-3 h-3 text-orange-600" />
                        <span className="text-sm font-medium text-orange-700">{scan.vuln_high}</span>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Medium</p>
                      <div className="flex items-center gap-1">
                        <AlertCircle className="w-3 h-3 text-yellow-600" />
                        <span className="text-sm font-medium text-yellow-700">{scan.vuln_medium}</span>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Low</p>
                      <div className="flex items-center gap-1">
                        <Info className="w-3 h-3 text-blue-600" />
                        <span className="text-sm font-medium text-blue-700">{scan.vuln_low}</span>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Info</p>
                      <div className="flex items-center gap-1">
                        <Info className="w-3 h-3 text-gray-600" />
                        <span className="text-sm font-medium text-gray-700">{scan.vuln_info}</span>
                      </div>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-4 gap-4 mb-4">
                    <div>
                      <p className="text-xs text-slate-500 mb-1">Scanned Items</p>
                      <p className="text-sm font-medium text-slate-900">{scan.scanned_items.toLocaleString()}</p>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Fixed</p>
                      <div className="flex items-center gap-1">
                        <CheckCircle2 className="w-3 h-3 text-green-600" />
                        <span className="text-sm font-medium text-green-700">{scan.fixed_count}</span>
                      </div>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Ignored</p>
                      <p className="text-sm font-medium text-slate-900">{scan.ignored_count}</p>
                    </div>

                    <div>
                      <p className="text-xs text-slate-500 mb-1">Duration</p>
                      <p className="text-sm font-medium text-slate-900">{formatDuration(scan.duration_seconds)}</p>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="text-xs text-slate-500 mb-1">Started At</p>
                      <div className="flex items-center gap-1">
                        <Calendar className="w-3 h-3 text-slate-400" />
                        <span className="text-sm text-slate-700">
                          {scan.started_at ? new Date(scan.started_at).toLocaleString() : 'Not started'}
                        </span>
                      </div>
                    </div>

                    {scan.completed_at && (
                      <div>
                        <p className="text-xs text-slate-500 mb-1">Completed At</p>
                        <div className="flex items-center gap-1">
                          <CheckCircle2 className="w-3 h-3 text-green-600" />
                          <span className="text-sm text-slate-700">
                            {new Date(scan.completed_at).toLocaleString()}
                          </span>
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-2 pt-4 border-t border-slate-100">
                    {scan.status === 'scheduled' && (
                      <button
                        onClick={() => handleStartScan(scan.id)}
                        className="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                      >
                        <Play className="w-4 h-4" />
                        Start Scan
                      </button>
                    )}
                    {scan.status === 'in-progress' && (
                      <button
                        onClick={() => handleCompleteScan(scan.id, true)}
                        className="flex-1 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-medium"
                      >
                        Mark Complete
                      </button>
                    )}
                    {scan.status === 'completed' && (
                      <>
                        <button className="flex-1 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-600 text-white rounded-lg text-sm font-medium hover:from-red-600 hover:to-orange-700 transition-all">
                          View Findings
                        </button>
                        <button
                          onClick={() => handleRescan(scan.id)}
                          className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all flex items-center gap-2"
                        >
                          <RefreshCw className="w-4 h-4" />
                          Rescan
                        </button>
                      </>
                    )}
                    <button className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                      Report
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Sidebar */}
          <div className="space-y-6">

            {/* Total Vulnerabilities */}
            <MiniKPI
              label="Total Vulnerabilities"
              value={stats.totalVulnerabilities.toString()}
              icon={AlertTriangle}
              trend={{ value: 15, isPositive: false }}
              className="bg-gradient-to-br from-red-500 to-orange-600"
            />

            {/* Recent Activity */}
            <ActivityFeed
              title="Recent Scans"
              activities={scans.slice(0, 4).map((scan) => ({
                id: scan.id,
                title: scan.name,
                description: `${scan.vuln_critical + scan.vuln_high} critical/high vulnerabilities`,
                timestamp: new Date(scan.created_at).toLocaleDateString(),
                type: scan.status === 'completed' ? 'success' :
                      scan.status === 'failed' ? 'error' :
                      scan.status === 'in-progress' ? 'info' : 'warning'
              }))}
            />

            {/* Vulnerability Types */}
            <RankingList
              title="By Severity"
              items={[
                { label: 'Critical', value: stats.criticalCount.toString(), rank: 1 },
                { label: 'High', value: stats.highCount.toString(), rank: 2 },
                { label: 'Medium', value: `${Math.round(stats.totalVulnerabilities * 0.3)}`, rank: 3 },
                { label: 'Low', value: `${Math.round(stats.totalVulnerabilities * 0.4)}`, rank: 4 }
              ]}
            />

            {/* Remediation Rate */}
            <ProgressCard
              title="Remediation Rate"
              progress={stats.fixRate}
              subtitle="Issues fixed vs total"
              color="red"
            />

          </div>
        </div>

      </div>
    </div>
  )
}
