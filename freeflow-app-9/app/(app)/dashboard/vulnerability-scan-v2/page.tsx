'use client'

import { useState } from 'react'
import {
  Search,
  Shield,
  AlertTriangle,
  CheckCircle2,
  XCircle,
  Clock,
  Activity,
  TrendingUp,
  Settings,
  Bug,
  Code,
  Package,
  Server,
  Database,
  Cloud,
  BarChart3,
  Calendar,
  Filter,
  Zap,
  FileText,
  AlertCircle,
  Info
} from 'lucide-react'
import StatGrid from '@/components/dashboard-results/StatGrid'
import BentoQuickAction from '@/components/dashboard-results/BentoQuickAction'
import PillButton from '@/components/modern-button-suite/PillButton'
import MiniKPI from '@/components/dashboard-results/MiniKPI'
import ActivityFeed from '@/components/dashboard-results/ActivityFeed'
import RankingList from '@/components/dashboard-results/RankingList'
import ProgressCard from '@/components/dashboard-results/ProgressCard'

type ScanStatus = 'completed' | 'in-progress' | 'failed' | 'scheduled'
type ScanType = 'dependency' | 'code' | 'container' | 'infrastructure' | 'web-application'
type Severity = 'info' | 'low' | 'medium' | 'high' | 'critical'

interface VulnerabilityScan {
  id: string
  name: string
  description: string
  type: ScanType
  status: ScanStatus
  startedAt: string
  completedAt: string
  duration: number
  scannedItems: number
  vulnerabilities: {
    critical: number
    high: number
    medium: number
    low: number
    info: number
  }
  fixed: number
  ignored: number
  scanner: string
  target: string
}

export default function VulnerabilityScanPage() {
  const [viewMode, setViewMode] = useState<'all' | ScanStatus>('all')
  const [typeFilter, setTypeFilter] = useState<'all' | ScanType>('all')

  const scans: VulnerabilityScan[] = [
    {
      id: 'SCAN-2847',
      name: 'Weekly Dependency Scan',
      description: 'Automated scan of npm and pip dependencies for known vulnerabilities',
      type: 'dependency',
      status: 'completed',
      startedAt: '2024-01-15 08:00',
      completedAt: '2024-01-15 08:12',
      duration: 720,
      scannedItems: 847,
      vulnerabilities: {
        critical: 2,
        high: 5,
        medium: 12,
        low: 23,
        info: 8
      },
      fixed: 15,
      ignored: 5,
      scanner: 'Snyk',
      target: 'package.json, requirements.txt'
    },
    {
      id: 'SCAN-2848',
      name: 'Static Code Analysis',
      description: 'SAST scan for security vulnerabilities in application code',
      type: 'code',
      status: 'in-progress',
      startedAt: '2024-01-15 14:00',
      completedAt: '',
      duration: 0,
      scannedItems: 12847,
      vulnerabilities: {
        critical: 1,
        high: 8,
        medium: 15,
        low: 34,
        info: 12
      },
      fixed: 0,
      ignored: 0,
      scanner: 'SonarQube',
      target: 'Application Source Code'
    },
    {
      id: 'SCAN-2849',
      name: 'Docker Image Security Scan',
      description: 'Container image vulnerability scan for production deployment',
      type: 'container',
      status: 'completed',
      startedAt: '2024-01-15 10:00',
      completedAt: '2024-01-15 10:18',
      duration: 1080,
      scannedItems: 234,
      vulnerabilities: {
        critical: 3,
        high: 12,
        medium: 28,
        low: 45,
        info: 15
      },
      fixed: 40,
      ignored: 8,
      scanner: 'Trivy',
      target: 'app:latest, nginx:1.21'
    },
    {
      id: 'SCAN-2850',
      name: 'Infrastructure Security Assessment',
      description: 'AWS infrastructure configuration and security posture scan',
      type: 'infrastructure',
      status: 'completed',
      startedAt: '2024-01-14 09:00',
      completedAt: '2024-01-14 11:30',
      duration: 9000,
      scannedItems: 456,
      vulnerabilities: {
        critical: 5,
        high: 15,
        medium: 34,
        low: 67,
        info: 23
      },
      fixed: 72,
      ignored: 12,
      scanner: 'Prowler',
      target: 'AWS Account (Production)'
    },
    {
      id: 'SCAN-2851',
      name: 'Web Application Penetration Test',
      description: 'DAST scan of public-facing web application for vulnerabilities',
      type: 'web-application',
      status: 'failed',
      startedAt: '2024-01-13 15:00',
      completedAt: '2024-01-13 16:30',
      duration: 5400,
      scannedItems: 1247,
      vulnerabilities: {
        critical: 7,
        high: 18,
        medium: 45,
        low: 89,
        info: 34
      },
      fixed: 0,
      ignored: 0,
      scanner: 'OWASP ZAP',
      target: 'https://app.example.com'
    },
    {
      id: 'SCAN-2852',
      name: 'Monthly Security Baseline Scan',
      description: 'Comprehensive security scan across all layers',
      type: 'infrastructure',
      status: 'scheduled',
      startedAt: '2024-02-01 00:00',
      completedAt: '',
      duration: 0,
      scannedItems: 0,
      vulnerabilities: {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0,
        info: 0
      },
      fixed: 0,
      ignored: 0,
      scanner: 'Nessus',
      target: 'All Infrastructure'
    }
  ]

  const filteredScans = scans.filter(scan => {
    if (viewMode !== 'all' && scan.status !== viewMode) return false
    if (typeFilter !== 'all' && scan.type !== typeFilter) return false
    return true
  })

  const totalScans = scans.length
  const completedScans = scans.filter(s => s.status === 'completed').length
  const totalVulnerabilities = scans.reduce((sum, s) =>
    sum + s.vulnerabilities.critical + s.vulnerabilities.high + s.vulnerabilities.medium + s.vulnerabilities.low, 0
  )
  const totalFixed = scans.reduce((sum, s) => sum + s.fixed, 0)

  const getStatusColor = (status: ScanStatus) => {
    switch (status) {
      case 'completed': return 'text-green-600 bg-green-50'
      case 'in-progress': return 'text-blue-600 bg-blue-50'
      case 'failed': return 'text-red-600 bg-red-50'
      case 'scheduled': return 'text-purple-600 bg-purple-50'
      default: return 'text-gray-600 bg-gray-50'
    }
  }

  const getTypeColor = (type: ScanType) => {
    switch (type) {
      case 'dependency': return 'text-blue-600 bg-blue-50'
      case 'code': return 'text-purple-600 bg-purple-50'
      case 'container': return 'text-cyan-600 bg-cyan-50'
      case 'infrastructure': return 'text-orange-600 bg-orange-50'
      case 'web-application': return 'text-green-600 bg-green-50'
      default: return 'text-gray-600 bg-gray-50'
    }
  }

  const formatDuration = (seconds: number) => {
    if (seconds === 0) return 'N/A'
    const minutes = Math.floor(seconds / 60)
    const secs = seconds % 60
    return minutes > 0 ? `${minutes}m ${secs}s` : `${secs}s`
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 p-8">
      <div className="max-w-7xl mx-auto space-y-8">

        {/* Header */}
        <div>
          <h1 className="text-4xl font-bold bg-gradient-to-r from-red-900 via-orange-800 to-yellow-900 bg-clip-text text-transparent mb-2">
            Vulnerability Scans
          </h1>
          <p className="text-slate-600">Security vulnerability detection and remediation tracking</p>
        </div>

        {/* Stats Grid */}
        <StatGrid
          stats={[
            {
              label: 'Total Scans',
              value: totalScans.toString(),
              icon: Search,
              trend: { value: 12, isPositive: true },
              color: 'red'
            },
            {
              label: 'Completed',
              value: completedScans.toString(),
              icon: CheckCircle2,
              trend: { value: 8, isPositive: true },
              color: 'green'
            },
            {
              label: 'Vulnerabilities',
              value: totalVulnerabilities.toString(),
              icon: AlertTriangle,
              trend: { value: 15, isPositive: false },
              color: 'orange'
            },
            {
              label: 'Fixed',
              value: totalFixed.toString(),
              icon: Shield,
              trend: { value: 25, isPositive: true },
              color: 'blue'
            }
          ]}
        />

        {/* Quick Actions */}
        <BentoQuickAction
          actions={[
            {
              title: 'New Scan',
              description: 'Run scan now',
              icon: Search,
              gradient: 'from-red-500 to-orange-600',
              onClick: () => console.log('New scan')
            },
            {
              title: 'Schedule Scan',
              description: 'Automate scans',
              icon: Calendar,
              gradient: 'from-blue-500 to-indigo-600',
              onClick: () => console.log('Schedule')
            },
            {
              title: 'View Vulnerabilities',
              description: 'All findings',
              icon: Bug,
              gradient: 'from-orange-500 to-red-600',
              onClick: () => console.log('Vulnerabilities')
            },
            {
              title: 'Remediation Queue',
              description: 'Fix issues',
              icon: CheckCircle2,
              gradient: 'from-green-500 to-emerald-600',
              onClick: () => console.log('Remediation')
            },
            {
              title: 'Reports',
              description: 'Export findings',
              icon: FileText,
              gradient: 'from-purple-500 to-pink-600',
              onClick: () => console.log('Reports')
            },
            {
              title: 'Integrations',
              description: 'Connect scanners',
              icon: Zap,
              gradient: 'from-cyan-500 to-blue-600',
              onClick: () => console.log('Integrations')
            },
            {
              title: 'Settings',
              description: 'Configure scans',
              icon: Settings,
              gradient: 'from-slate-500 to-gray-600',
              onClick: () => console.log('Settings')
            },
            {
              title: 'Alert Rules',
              description: 'Set notifications',
              icon: Bell,
              gradient: 'from-indigo-500 to-purple-600',
              onClick: () => console.log('Alerts')
            }
          ]}
        />

        {/* Filters */}
        <div className="flex flex-wrap gap-3">
          <div className="flex gap-2">
            <PillButton
              label="All Scans"
              isActive={viewMode === 'all'}
              onClick={() => setViewMode('all')}
            />
            <PillButton
              label="Completed"
              isActive={viewMode === 'completed'}
              onClick={() => setViewMode('completed')}
            />
            <PillButton
              label="In Progress"
              isActive={viewMode === 'in-progress'}
              onClick={() => setViewMode('in-progress')}
            />
            <PillButton
              label="Failed"
              isActive={viewMode === 'failed'}
              onClick={() => setViewMode('failed')}
            />
          </div>

          <div className="flex gap-2">
            <PillButton
              label="All Types"
              isActive={typeFilter === 'all'}
              onClick={() => setTypeFilter('all')}
            />
            <PillButton
              label="Dependencies"
              isActive={typeFilter === 'dependency'}
              onClick={() => setTypeFilter('dependency')}
            />
            <PillButton
              label="Code"
              isActive={typeFilter === 'code'}
              onClick={() => setTypeFilter('code')}
            />
            <PillButton
              label="Container"
              isActive={typeFilter === 'container'}
              onClick={() => setTypeFilter('container')}
            />
          </div>
        </div>

        {/* Main Content Grid */}
        <div className="grid lg:grid-cols-3 gap-8">

          {/* Scans List */}
          <div className="lg:col-span-2 space-y-4">
            {filteredScans.map((scan) => (
              <div
                key={scan.id}
                className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-all"
              >
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <Search className="w-5 h-5 text-red-600" />
                      <h3 className="font-semibold text-slate-900">{scan.name}</h3>
                    </div>
                    <p className="text-sm text-slate-600 mb-1">{scan.description}</p>
                    <p className="text-xs text-slate-500">Scan ID: {scan.id}</p>
                  </div>
                  <div className="flex gap-2">
                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(scan.status)}`}>
                      {scan.status}
                    </span>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium ${getTypeColor(scan.type)}`}>
                      {scan.type}
                    </span>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <p className="text-xs text-slate-500 mb-1">Scanner</p>
                    <p className="text-sm font-medium text-slate-900">{scan.scanner}</p>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Target</p>
                    <p className="text-sm font-medium text-slate-900">{scan.target}</p>
                  </div>
                </div>

                <div className="grid grid-cols-5 gap-4 mb-4">
                  <div>
                    <p className="text-xs text-slate-500 mb-1">Critical</p>
                    <div className="flex items-center gap-1">
                      <XCircle className="w-3 h-3 text-red-600" />
                      <span className="text-sm font-medium text-red-700">{scan.vulnerabilities.critical}</span>
                    </div>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">High</p>
                    <div className="flex items-center gap-1">
                      <AlertTriangle className="w-3 h-3 text-orange-600" />
                      <span className="text-sm font-medium text-orange-700">{scan.vulnerabilities.high}</span>
                    </div>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Medium</p>
                    <div className="flex items-center gap-1">
                      <AlertCircle className="w-3 h-3 text-yellow-600" />
                      <span className="text-sm font-medium text-yellow-700">{scan.vulnerabilities.medium}</span>
                    </div>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Low</p>
                    <div className="flex items-center gap-1">
                      <Info className="w-3 h-3 text-blue-600" />
                      <span className="text-sm font-medium text-blue-700">{scan.vulnerabilities.low}</span>
                    </div>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Info</p>
                    <div className="flex items-center gap-1">
                      <Info className="w-3 h-3 text-gray-600" />
                      <span className="text-sm font-medium text-gray-700">{scan.vulnerabilities.info}</span>
                    </div>
                  </div>
                </div>

                <div className="grid md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <p className="text-xs text-slate-500 mb-1">Scanned Items</p>
                    <p className="text-sm font-medium text-slate-900">{scan.scannedItems.toLocaleString()}</p>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Fixed</p>
                    <div className="flex items-center gap-1">
                      <CheckCircle2 className="w-3 h-3 text-green-600" />
                      <span className="text-sm font-medium text-green-700">{scan.fixed}</span>
                    </div>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Ignored</p>
                    <p className="text-sm font-medium text-slate-900">{scan.ignored}</p>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-1">Duration</p>
                    <p className="text-sm font-medium text-slate-900">{formatDuration(scan.duration)}</p>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <p className="text-xs text-slate-500 mb-1">Started At</p>
                    <div className="flex items-center gap-1">
                      <Calendar className="w-3 h-3 text-slate-400" />
                      <span className="text-sm text-slate-700">{scan.startedAt}</span>
                    </div>
                  </div>

                  {scan.completedAt && (
                    <div>
                      <p className="text-xs text-slate-500 mb-1">Completed At</p>
                      <div className="flex items-center gap-1">
                        <CheckCircle2 className="w-3 h-3 text-green-600" />
                        <span className="text-sm text-slate-700">{scan.completedAt}</span>
                      </div>
                    </div>
                  )}
                </div>

                <div className="flex gap-2 pt-4 border-t border-slate-100">
                  <button className="flex-1 px-4 py-2 bg-gradient-to-r from-red-500 to-orange-600 text-white rounded-lg text-sm font-medium hover:from-red-600 hover:to-orange-700 transition-all">
                    View Findings
                  </button>
                  <button className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                    Report
                  </button>
                  <button className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all">
                    {scan.status === 'completed' ? 'Rescan' : 'Details'}
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Sidebar */}
          <div className="space-y-6">

            {/* Total Vulnerabilities */}
            <MiniKPI
              label="Total Vulnerabilities"
              value={totalVulnerabilities.toString()}
              icon={AlertTriangle}
              trend={{ value: 15, isPositive: false }}
              className="bg-gradient-to-br from-red-500 to-orange-600"
            />

            {/* Recent Activity */}
            <ActivityFeed
              title="Recent Scans"
              activities={[
                {
                  id: '1',
                  title: 'Code analysis in progress',
                  description: '70 vulnerabilities found',
                  timestamp: '1 hour ago',
                  type: 'info'
                },
                {
                  id: '2',
                  title: 'Dependency scan completed',
                  description: '50 issues - 15 fixed',
                  timestamp: '6 hours ago',
                  type: 'success'
                },
                {
                  id: '3',
                  title: 'Container scan completed',
                  description: '103 vulnerabilities - 40 fixed',
                  timestamp: '1 day ago',
                  type: 'warning'
                },
                {
                  id: '4',
                  title: 'Web app scan failed',
                  description: 'Scanner timeout error',
                  timestamp: '2 days ago',
                  type: 'error'
                }
              ]}
            />

            {/* Vulnerability Types */}
            <RankingList
              title="By Severity"
              items={[
                { label: 'Low', value: '45%', rank: 1 },
                { label: 'Medium', value: '28%', rank: 2 },
                { label: 'High', value: '18%', rank: 3 },
                { label: 'Critical', value: '9%', rank: 4 }
              ]}
            />

            {/* Remediation Rate */}
            <ProgressCard
              title="Remediation Rate"
              progress={67}
              subtitle="Issues fixed vs total"
              color="red"
            />

          </div>
        </div>

      </div>
    </div>
  )
}
