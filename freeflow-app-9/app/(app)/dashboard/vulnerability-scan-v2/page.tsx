import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import VulnerabilityScanClient from './vulnerability-scan-client'

export const dynamic = 'force-dynamic'

/**
 * Vulnerability Scan V2 - Security Vulnerability Detection
 * Server-side rendered with real-time client updates
 */
export default async function VulnerabilityScanV2Page() {
  const supabase = createServerComponentClient({ cookies })

  const { data: { user } } = await supabase.auth.getUser()

  let scans: any[] = []
  let stats = {
    total: 0,
    scheduled: 0,
    inProgress: 0,
    completed: 0,
    failed: 0,
    totalVulnerabilities: 0,
    criticalCount: 0,
    highCount: 0,
    fixedCount: 0,
    fixRate: 0
  }

  if (user) {
    // Fetch vulnerability scans
    const { data: scansData } = await supabase
      .from('vulnerability_scans')
      .select('*')
      .eq('user_id', user.id)
      .is('deleted_at', null)
      .order('created_at', { ascending: false })
      .limit(100)

    scans = scansData || []

    if (scans.length > 0) {
      const totalVulns = scans.reduce((sum, s) =>
        sum + (s.vuln_critical || 0) + (s.vuln_high || 0) + (s.vuln_medium || 0) + (s.vuln_low || 0), 0
      )
      const totalFixed = scans.reduce((sum, s) => sum + (s.fixed_count || 0), 0)

      stats = {
        total: scans.length,
        scheduled: scans.filter(s => s.status === 'scheduled').length,
        inProgress: scans.filter(s => s.status === 'in-progress').length,
        completed: scans.filter(s => s.status === 'completed').length,
        failed: scans.filter(s => s.status === 'failed').length,
        totalVulnerabilities: totalVulns,
        criticalCount: scans.reduce((sum, s) => sum + (s.vuln_critical || 0), 0),
        highCount: scans.reduce((sum, s) => sum + (s.vuln_high || 0), 0),
        fixedCount: totalFixed,
        fixRate: totalVulns > 0 ? (totalFixed / totalVulns) * 100 : 0
      }
    }
  }

  return (
    <VulnerabilityScanClient
      initialScans={scans}
      initialStats={stats}
    />
  )
}
