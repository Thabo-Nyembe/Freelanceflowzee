/**
 * Storage Provider Integration
 * Supports: Google Drive, Dropbox, OneDrive, Box, iCloud
 * Features: Error handling, retry logic, token refresh
 */

export type StorageProvider =
  | 'google-drive'
  | 'dropbox'
  | 'onedrive'
  | 'box'
  | 'icloud'
  | 'local'

export class StorageProviderError extends Error {
  constructor(
    message: string,
    public provider: StorageProvider,
    public statusCode?: number,
    public originalError?: any
  ) {
    super(message)
    this.name = 'StorageProviderError'
  }
}

/**
 * Retry failed API requests with exponential backoff
 */
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3,
  initialDelay: number = 1000
): Promise<T> {
  let lastError: any

  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn()
    } catch (error: any) {
      lastError = error

      // Don't retry on 4xx errors (except 429 rate limit)
      if (error.status >= 400 && error.status < 500 && error.status !== 429) {
        throw error
      }

      // Wait with exponential backoff
      if (i < maxRetries - 1) {
        const delay = initialDelay * Math.pow(2, i)
        await new Promise(resolve => setTimeout(resolve, delay))
      }
    }
  }

  throw lastError
}

export interface StorageFile {
  id: string
  name: string
  path: string
  size: number
  mimeType: string
  createdAt: string
  modifiedAt: string
  provider: StorageProvider
  thumbnail?: string
  downloadUrl?: string
  webViewUrl?: string
  isFolder: boolean
  parentId?: string
}

export interface StorageConnection {
  id: string
  userId: string
  provider: StorageProvider
  accessToken: string
  refreshToken?: string
  expiresAt?: string
  accountEmail?: string
  accountName?: string
  totalSpace?: number
  usedSpace?: number
  connected: boolean
  lastSync?: string
  createdAt: string
  updatedAt: string
}

export interface StorageProviderConfig {
  name: string
  icon: string
  color: string
  scopes: string[]
  authUrl: string
  tokenUrl: string
}

export const STORAGE_PROVIDERS: Record<StorageProvider, StorageProviderConfig> = {
  'google-drive': {
    name: 'Google Drive',
    icon: 'üìÅ',
    color: '#4285F4',
    scopes: [
      'https://www.googleapis.com/auth/drive.readonly',
      'https://www.googleapis.com/auth/drive.file'
    ],
    authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
    tokenUrl: 'https://oauth2.googleapis.com/token'
  },
  'dropbox': {
    name: 'Dropbox',
    icon: 'üì¶',
    color: '#0061FF',
    scopes: ['files.metadata.read', 'files.content.read'],
    authUrl: 'https://www.dropbox.com/oauth2/authorize',
    tokenUrl: 'https://api.dropboxapi.com/oauth2/token'
  },
  'onedrive': {
    name: 'OneDrive',
    icon: '‚òÅÔ∏è',
    color: '#0078D4',
    scopes: ['Files.Read', 'Files.Read.All', 'offline_access'],
    authUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize',
    tokenUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/token'
  },
  'box': {
    name: 'Box',
    icon: 'üìÆ',
    color: '#0061D5',
    scopes: ['root_readwrite'],
    authUrl: 'https://account.box.com/api/oauth2/authorize',
    tokenUrl: 'https://api.box.com/oauth2/token'
  },
  'icloud': {
    name: 'iCloud Drive',
    icon: '‚òÅÔ∏è',
    color: '#000000',
    scopes: ['cloudDrive'],
    authUrl: 'https://appleid.apple.com/auth/authorize',
    tokenUrl: 'https://appleid.apple.com/auth/token'
  },
  'local': {
    name: 'Local Storage',
    icon: 'üíæ',
    color: '#6B7280',
    scopes: [],
    authUrl: '',
    tokenUrl: ''
  }
}

/**
 * Storage Provider API Clients
 */
export class GoogleDriveClient {
  constructor(private accessToken: string) {}

  async listFiles(folderId?: string): Promise<StorageFile[]> {
    return retryWithBackoff(async () => {
      try {
        const query = folderId
          ? `'${folderId}' in parents and trashed=false`
          : "'root' in parents and trashed=false"

        const response = await fetch(
          `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,size,createdTime,modifiedTime,thumbnailLink,webViewLink,parents)`,
          {
            headers: {
              'Authorization': `Bearer ${this.accessToken}`
            }
          }
        )

        if (!response.ok) {
          throw new StorageProviderError(
            `Failed to list files: ${response.statusText}`,
            'google-drive',
            response.status
          )
        }

        const data = await response.json()

        if (data.error) {
          throw new StorageProviderError(
            data.error.message || 'Failed to list files',
            'google-drive',
            data.error.code
          )
        }

        return data.files?.map((file: any) => ({
          id: file.id,
          name: file.name,
          path: `/${file.name}`,
          size: parseInt(file.size || '0'),
          mimeType: file.mimeType,
          createdAt: file.createdTime,
          modifiedAt: file.modifiedTime,
          provider: 'google-drive' as StorageProvider,
          thumbnail: file.thumbnailLink,
          webViewUrl: file.webViewLink,
          isFolder: file.mimeType === 'application/vnd.google-apps.folder',
          parentId: file.parents?.[0]
        })) || []
      } catch (error: any) {
        if (error instanceof StorageProviderError) throw error
        throw new StorageProviderError(
          `Google Drive error: ${error.message}`,
          'google-drive',
          undefined,
          error
        )
      }
    })
  }

  async downloadFile(fileId: string): Promise<Blob> {
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
      {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      }
    )
    return response.blob()
  }

  async getStorageQuota(): Promise<{ total: number; used: number }> {
    const response = await fetch(
      'https://www.googleapis.com/drive/v3/about?fields=storageQuota',
      {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      }
    )
    const data = await response.json()
    return {
      total: parseInt(data.storageQuota?.limit || '0'),
      used: parseInt(data.storageQuota?.usage || '0')
    }
  }
}

export class DropboxClient {
  constructor(private accessToken: string) {}

  async listFiles(path: string = ''): Promise<StorageFile[]> {
    const response = await fetch(
      'https://api.dropboxapi.com/2/files/list_folder',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ path: path || '' })
      }
    )

    const data = await response.json()

    return data.entries?.map((entry: any) => ({
      id: entry.id,
      name: entry.name,
      path: entry.path_display,
      size: entry.size || 0,
      mimeType: entry['.tag'] === 'folder' ? 'folder' : 'file',
      createdAt: entry.client_modified || entry.server_modified,
      modifiedAt: entry.server_modified,
      provider: 'dropbox' as StorageProvider,
      isFolder: entry['.tag'] === 'folder'
    })) || []
  }

  async downloadFile(path: string): Promise<Blob> {
    const response = await fetch(
      'https://content.dropboxapi.com/2/files/download',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Dropbox-API-Arg': JSON.stringify({ path })
        }
      }
    )
    return response.blob()
  }

  async getStorageQuota(): Promise<{ total: number; used: number }> {
    const response = await fetch(
      'https://api.dropboxapi.com/2/users/get_space_usage',
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      }
    )
    const data = await response.json()
    return {
      total: data.allocation?.allocated || 0,
      used: data.used || 0
    }
  }
}

export class OneDriveClient {
  constructor(private accessToken: string) {}

  async listFiles(folderId?: string): Promise<StorageFile[]> {
    const endpoint = folderId
      ? `https://graph.microsoft.com/v1.0/me/drive/items/${folderId}/children`
      : 'https://graph.microsoft.com/v1.0/me/drive/root/children'

    const response = await fetch(endpoint, {
      headers: {
        'Authorization': `Bearer ${this.accessToken}`
      }
    })

    const data = await response.json()

    return data.value?.map((item: any) => ({
      id: item.id,
      name: item.name,
      path: item.parentReference?.path + '/' + item.name,
      size: item.size || 0,
      mimeType: item.file?.mimeType || 'folder',
      createdAt: item.createdDateTime,
      modifiedAt: item.lastModifiedDateTime,
      provider: 'onedrive' as StorageProvider,
      thumbnail: item.thumbnails?.[0]?.large?.url,
      webViewUrl: item.webUrl,
      isFolder: !!item.folder,
      parentId: item.parentReference?.id
    })) || []
  }

  async downloadFile(itemId: string): Promise<Blob> {
    const response = await fetch(
      `https://graph.microsoft.com/v1.0/me/drive/items/${itemId}/content`,
      {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      }
    )
    return response.blob()
  }

  async getStorageQuota(): Promise<{ total: number; used: number }> {
    const response = await fetch(
      'https://graph.microsoft.com/v1.0/me/drive',
      {
        headers: {
          'Authorization': `Bearer ${this.accessToken}`
        }
      }
    )
    const data = await response.json()
    return {
      total: data.quota?.total || 0,
      used: data.quota?.used || 0
    }
  }
}

/**
 * Unified Storage Client - Single interface for all providers
 */
export class UnifiedStorageClient {
  private client: GoogleDriveClient | DropboxClient | OneDriveClient

  constructor(provider: StorageProvider, accessToken: string) {
    switch (provider) {
      case 'google-drive':
        this.client = new GoogleDriveClient(accessToken)
        break
      case 'dropbox':
        this.client = new DropboxClient(accessToken)
        break
      case 'onedrive':
        this.client = new OneDriveClient(accessToken)
        break
      default:
        throw new Error(`Unsupported provider: ${provider}`)
    }
  }

  async listFiles(folderId?: string): Promise<StorageFile[]> {
    return this.client.listFiles(folderId)
  }

  async downloadFile(fileId: string): Promise<Blob> {
    return this.client.downloadFile(fileId)
  }

  async getStorageQuota(): Promise<{ total: number; used: number }> {
    return this.client.getStorageQuota()
  }
}
